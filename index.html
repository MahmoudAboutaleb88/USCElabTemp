<!DOCTYPE html>
<html>
<head>
    <title>USCE Lab Data Loggers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #667eea; font-size: 28px; }
        
        .add-device-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s;
            margin-left: 10px;
        }
        .add-device-btn:hover { transform: translateY(-2px); }
        
        .reconnect-all-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            transition: transform 0.2s;
        }
        .reconnect-all-btn:hover { transform: translateY(-2px); }
        .reconnect-all-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .device-card {
            background: white;
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .device-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .device-card.alarm { animation: pulse 1s infinite; border: 3px solid #ff4444; }
        .device-card.disconnected { opacity: 0.6; border: 2px dashed #ccc; }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.6); }
            50% { box-shadow: 0 0 40px rgba(255, 68, 68, 0.9); }
        }
        
        .device-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
        }
        .status-badge.disconnected { background: #999; }
        .status-badge.alarm { background: #ff4444; }
        
        .data-display {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }
        
        .temp-display {
            font-size: 42px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .humidity-display {
            font-size: 24px;
            color: #0288d1;
            margin-bottom: 10px;
        }
        
        .battery-display {
            font-size: 16px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 20px;
            padding: 30px;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }
        .close-btn:hover { color: #333; }
        
        .detail-section {
            background: #f5f5f5;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .control-group input, .control-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .alarm-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .button.danger { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); }
        .button.success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }
        .empty-state h2 { font-size: 32px; margin-bottom: 10px; }
        
        .device-list-item {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .device-list-item:hover {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .log-entry {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            border-left: 4px solid #667eea;
        }
        .log-entry.alarm { border-left-color: #ff4444; background: #ffebee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä USCE Lab Data Loggers</h1>
            <div>
                <button class="reconnect-all-btn" onclick="reconnectAllDevices()" id="reconnectAllBtn" style="display: none;">
                    üîÑ Reconnect All
                </button>
                <button class="add-device-btn" onclick="openAddDeviceModal()">‚ûï Add Device</button>
            </div>
        </div>

        <div id="devicesGrid" class="devices-grid"></div>
        
        <div id="emptyState" class="empty-state">
            <h2>üîå No Devices Connected</h2>
            <p>Click "Add Device" to connect your first Xiaomi sensor</p>
        </div>
    </div>
<!-- Add Device Modal -->
<div id="addDeviceModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeAddDeviceModal()">&times;</span>
        <h2 style="margin-bottom: 20px;">üîç Add New Device</h2>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <h4>üìã Before Scanning:</h4>
            <ul style="text-align: left; margin: 10px 0; padding-left: 20px;">
                <li>Use <strong>Chrome/Edge</strong> browser</li>
                <li>Enable <strong>Bluetooth</strong> on your device</li>
                <li>Keep sensor <strong>nearby</strong></li>
            </ul>
        </div>
        
        <div id="scanningState" style="text-align: center; padding: 30px; display: none;">
            <div style="font-size: 48px; margin-bottom: 20px;">üîç</div>
            <h3>Scanning for devices...</h3>
            <p>Check your device list and select your Xiaomi sensor</p>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 10px;">
                <strong>üí° Tip:</strong> Look for devices starting with:<br>
                <code>LYWSD</code>, <code>MHO-C401</code>, <code>Xiaomi</code>, <code>ATC</code>
            </div>
        </div>
        
        <div id="deviceNameInput" style="display: none;">
            <div class="control-group">
                <label>üìù Device Name:</label>
                <input type="text" id="newDeviceName" placeholder="e.g., Living Room, Bedroom">
            </div>
            
            <button class="button success" onclick="finalizeDevice()">‚úÖ Add Device</button>
        </div>
        
        <button class="button" onclick="scanForDevices()" id="scanBtn">
            üîç Scan for Bluetooth Devices
        </button>
    </div>
</div>

    <!-- Device Detail Modal -->
    <div id="deviceDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDetailModal()">&times;</span>
            <h2 id="detailDeviceName" style="margin-bottom: 20px;"></h2>
            
            <div class="detail-section">
                <div id="connectionStatus" style="display: none; background: #ffebee; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è Device Disconnected</div>
                    <p style="color: #666; margin-bottom: 15px;">This device is not connected. Connect now to get live data.</p>
                    <button class="button success" onclick="connectFromDetail()" style="max-width: 300px; margin: 0 auto;">
                        üîó Connect Device
                    </button>
                </div>
                
                <h3>üìà Live Data</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #1976d2;" id="detailTemp">--¬∞C</div>
                        <div style="color: #666;">Temperature</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 36px; font-weight: bold; color: #0288d1;" id="detailHumidity">--%</div>
                        <div style="color: #666;">Humidity</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px; color: #666;" id="detailBattery">üîã --%</div>
            </div>
            
            <div class="detail-section">
                <h3>üö® Alarm Settings</h3>
                
                <h4 style="margin: 15px 0 10px 0; color: #1976d2;">üå°Ô∏è Temperature Limits</h4>
                <div class="alarm-settings">
                    <div class="control-group">
                        <label>Max Temperature (¬∞C):</label>
                        <input type="number" id="maxTemp" value="27" step="0.5">
                    </div>
                    <div class="control-group">
                        <label>Min Temperature (¬∞C):</label>
                        <input type="number" id="minTemp" value="18" step="0.5">
                    </div>
                </div>
                
                <h4 style="margin: 15px 0 10px 0; color: #0288d1;">üíß Humidity Limits</h4>
                <div class="alarm-settings">
                    <div class="control-group">
                        <label>Max Humidity (%):</label>
                        <input type="number" id="maxHumidity" value="70" step="1" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label>Min Humidity (%):</label>
                        <input type="number" id="minHumidity" value="30" step="1" min="0" max="100">
                    </div>
                </div>
                
                <label style="display: flex; align-items: center; gap: 10px; margin-top: 15px; cursor: pointer;">
                    <input type="checkbox" id="alarmEnabled" checked style="width: 20px; height: 20px;">
                    <span>Enable Alarm</span>
                </label>
                <button class="button" onclick="updateAlarmSettings()">üíæ Save Settings</button>
            </div>
            
            <div class="detail-section">
                <h3>üìù Data Log</h3>
                <button class="button" onclick="startDeviceLogging()" id="startLogBtnDetail">‚ñ∂Ô∏è Start Logging</button>
                <button class="button danger" onclick="stopDeviceLogging()" id="stopLogBtnDetail">‚èπÔ∏è Stop Logging</button>
                <button class="button success" onclick="exportDeviceData()">üíæ Export CSV</button>
                <div class="log-container" id="detailLogContainer"></div>
            </div>
            
            <button class="button danger" onclick="removeDevice()">üóëÔ∏è Remove Device</button>
        </div>
    </div>

    <script>
        // Constants
        const XIAOMI_SERVICE = 'ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6';
        const TEMP_HUMIDITY_CHAR = 'ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6';
        const BATTERY_CHAR = 'ebe0ccc4-7a0a-4b0c-8a1a-6ff2997da3a6';

        // Global state
        let devices = [];
        let currentDeviceId = null;
        let selectedDevice = null;

        // Load devices from storage
        function loadDevices() {
            const saved = localStorage.getItem('xiaomiDevices');
            if (saved) {
                devices = JSON.parse(saved);
                // Reset connection status for all devices
                devices.forEach(device => {
                    device.connected = false;
                    device.bleDevice = null;
                    device.server = null;
                    device.alarmActive = false;
                    device.alarmType = '';
                    // Set default humidity limits if not exist
                    if (!device.maxHumidity) device.maxHumidity = 70;
                    if (!device.minHumidity) device.minHumidity = 30;
                });
            }
            renderDevices();
        }

        // Save devices to storage
        function saveDevices() {
            localStorage.setItem('xiaomiDevices', JSON.stringify(devices));
        }

        // Render all device cards
        function renderDevices() {
            const grid = document.getElementById('devicesGrid');
            const emptyState = document.getElementById('emptyState');
            const reconnectAllBtn = document.getElementById('reconnectAllBtn');
            
            if (devices.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                reconnectAllBtn.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Show reconnect all button if there are disconnected devices
            const hasDisconnected = devices.some(d => !d.connected);
            reconnectAllBtn.style.display = hasDisconnected ? 'inline-block' : 'none';
            
            grid.innerHTML = devices.map(device => {
                let alarmInfo = '';
                if (device.alarmActive) {
                    if (device.alarmType === 'temp') {
                        alarmInfo = '<div style="text-align: center; color: #ff4444; font-size: 12px; margin-top: 5px;">üå°Ô∏è Temperature Alert!</div>';
                    } else if (device.alarmType === 'humidity') {
                        alarmInfo = '<div style="text-align: center; color: #ff4444; font-size: 12px; margin-top: 5px;">üíß Humidity Alert!</div>';
                    } else if (device.alarmType === 'both') {
                        alarmInfo = '<div style="text-align: center; color: #ff4444; font-size: 12px; margin-top: 5px;">‚ö†Ô∏è Temp & Humidity Alert!</div>';
                    }
                }
                
return `
    <div class="device-card ${device.alarmActive ? 'alarm' : ''} ${!device.connected ? 'disconnected' : ''}" onclick="openDeviceDetail('${device.id}')">
        <div class="device-name">
            <span class="status-badge ${device.connected ? (device.alarmActive ? 'alarm' : '') : 'disconnected'}"></span>
            ${device.name}
        </div>
        <div class="data-display">
            <div class="temp-display">${device.temperature?.toFixed(1) || '--'}¬∞C</div>
            <div class="humidity-display">üíß ${device.humidity ? Math.round(device.humidity) : '--'}%</div>
            <div class="battery-display">üîã ${device.battery ? Math.round(device.battery) : '--'}%</div>
        </div>
        ${alarmInfo}
        ${!device.connected ? '<div style="text-align: center; color: #999; font-size: 12px; margin-top: 10px;">‚ö†Ô∏è Tap to connect</div>' : ''}
    </div>
`;
            }).join('');
        }

        // Add device modal
        function openAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'block';
        }

        function closeAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
            document.getElementById('scanningState').style.display = 'none';
            document.getElementById('deviceNameInput').style.display = 'none';
            document.getElementById('scanBtn').style.display = 'block';
        }

async function scanForDevices() {
    try {
        console.log('Starting Bluetooth scan...');
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('scanningState').style.display = 'block';

        // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿØÿπŸÖ Web Bluetooth
        if (!navigator.bluetooth) {
            throw new Error('‚ö†Ô∏è Web Bluetooth not supported! Use Chrome or Edge on Windows/Mac/Android.');
        }

        console.log('Web Bluetooth is supported, requesting device...');
        
const device = await navigator.bluetooth.requestDevice({
    filters: [
        { namePrefix: 'LYWSD' },    // ÿ£ÿ¨Ÿáÿ≤ÿ© LYWSD03MMC
        { namePrefix: 'MHO-C401' }, // ÿ£ÿ¨Ÿáÿ≤ÿ© MHO-C401
        { namePrefix: 'Xiaomi' },   // ÿ£Ÿä ÿ¨Ÿáÿßÿ≤ ÿ®Ÿäÿ®ÿØÿ£ ÿ®ŸÄ Xiaomi
        { namePrefix: 'MJ_HT' },    // ÿ£ÿ¨Ÿáÿ≤ÿ© MiJia
        { namePrefix: 'ClearGrass' }, // ÿ£ÿ¨Ÿáÿ≤ÿ© ClearGrass
        { namePrefix: 'Flower' },   // ÿ£ÿ¨Ÿáÿ≤ÿ© Flower Care
        { namePrefix: 'HHCC' },     // ÿ£ÿ¨Ÿáÿ≤ÿ© HHCC
        { namePrefix: 'ATC' }       // ÿ£ÿ¨Ÿáÿ≤ÿ© ATC (Custom firmware)
    ],
    optionalServices: [
        XIAOMI_SERVICE,
        'battery_service',
        'device_information',
        '0000180f-0000-1000-8000-00805f9b34fb',
        '0000180a-0000-1000-8000-00805f9b34fb'
    ]
});

        console.log('‚úÖ Device selected:', device.name);
        selectedDevice = device;


        document.getElementById('scanningState').style.display = 'none';
        document.getElementById('deviceNameInput').style.display = 'block';
        document.getElementById('newDeviceName').value = device.name || 'Xiaomi Sensor';


    } catch (error) {
        console.error('‚ùå Scan failed:', error);
        
        let errorMessage = '‚ùå Bluetooth Error: ';
        
        if (error.name === 'NotFoundError') {
            errorMessage = 'üîç No Bluetooth devices found! Make sure:\n‚Ä¢ Bluetooth is ON\n‚Ä¢ Sensor is nearby\n‚Ä¢ Sensor is in pairing mode';
        } else if (error.name === 'NotAllowedError') {
            errorMessage = 'üö´ Permission denied! Please allow Bluetooth access.';
        } else if (error.name === 'SecurityError') {
            errorMessage = 'üåê Use HTTPS or localhost for Bluetooth access.';
        } else {
            errorMessage += error.message;
        }
        
        alert(errorMessage);
        closeAddDeviceModal();
    }
}

        async function finalizeDevice() {
            const name = document.getElementById('newDeviceName').value.trim();
            if (!name) {
                alert('Please enter a device name');
                return;
            }

            const deviceId = 'dev_' + Date.now();
            const newDevice = {
                id: deviceId,
                name: name,
                bleDevice: null,
                server: null,
                connected: false,
                temperature: 0,
                humidity: 0,
                battery: 0,
                maxTemp: 27,
                minTemp: 18,
                maxHumidity: 70,
                minHumidity: 30,
                alarmEnabled: true,
                alarmActive: false,
                alarmType: '', // 'temp' or 'humidity' or 'both'
                logs: []
            };

            devices.push(newDevice);
            saveDevices();
            renderDevices();
            closeAddDeviceModal();

            // Connect to device
            await connectDevice(deviceId, selectedDevice);
        }

        // Connect to BLE device
        async function connectDevice(deviceId, bleDevice) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            try {
                const server = await bleDevice.gatt.connect();
                device.server = server;
                device.bleDevice = bleDevice;
                device.connected = true;

                bleDevice.addEventListener('gattserverdisconnected', () => {
                    device.connected = false;
                    renderDevices();
                });

                // Start reading data
                await startReadingData(deviceId);
                
                renderDevices();
            } catch (error) {
                console.error('Connection error:', error);
                device.connected = false;
            }
        }

        // Start reading sensor data
        async function startReadingData(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device || !device.server) return;

            try {
                const service = await device.server.getPrimaryService(XIAOMI_SERVICE);
                
                // Temperature & Humidity
                const tempChar = await service.getCharacteristic(TEMP_HUMIDITY_CHAR);
                await tempChar.startNotifications();
                tempChar.addEventListener('characteristicvaluechanged', (event) => {
                    parseSensorData(deviceId, event.target.value);
                });

                // Initial read
                const value = await tempChar.readValue();
                parseSensorData(deviceId, value);

                // Battery
                const batteryChar = await service.getCharacteristic(BATTERY_CHAR);
                const batteryValue = await batteryChar.readValue();
                device.battery = batteryValue.getUint8(0);

                // Update periodically
                setInterval(async () => {
                    if (device.connected) {
                        const val = await tempChar.readValue();
                        parseSensorData(deviceId, val);
                        const batVal = await batteryChar.readValue();
                        device.battery = batVal.getUint8(0);
                    }
                }, 3000);

            } catch (error) {
                console.error('Read error:', error);
            }
        }

        // Parse sensor data
        function parseSensorData(deviceId, value) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            const tempRaw = value.getInt16(0, true);
            const humidityRaw = value.getUint8(2);

            device.temperature = tempRaw / 100.0;
            device.humidity = humidityRaw;

            // Check alarm
            checkAlarm(device);

            renderDevices();
            
            // Update detail modal if open
            if (currentDeviceId === deviceId) {
                updateDetailModal(device);
            }
        }

        // Check alarm conditions
        function checkAlarm(device) {
            if (!device.alarmEnabled) {
                device.alarmActive = false;
                device.alarmType = '';
                return;
            }

            const temp = device.temperature;
            const humidity = device.humidity;
            
            const tempAlarm = temp > device.maxTemp || temp < device.minTemp;
            const humidityAlarm = humidity > device.maxHumidity || humidity < device.minHumidity;
            
            const isAlarm = tempAlarm || humidityAlarm;

            if (isAlarm && !device.alarmActive) {
                device.alarmActive = true;
                
                // Determine alarm type
                if (tempAlarm && humidityAlarm) {
                    device.alarmType = 'both';
                } else if (tempAlarm) {
                    device.alarmType = 'temp';
                } else {
                    device.alarmType = 'humidity';
                }
                
                playAlarmSound();
                
                // Show notification
                showAlarmNotification(device);
                
            } else if (!isAlarm) {
                device.alarmActive = false;
                device.alarmType = '';
            }
        }

        // Show alarm notification
        function showAlarmNotification(device) {
            let message = `üö® ${device.name} ALARM!\n`;
            
            if (device.alarmType === 'temp' || device.alarmType === 'both') {
                if (device.temperature > device.maxTemp) {
                    message += `üå°Ô∏è Temperature too HIGH: ${device.temperature.toFixed(1)}¬∞C (Max: ${device.maxTemp}¬∞C)\n`;
                } else if (device.temperature < device.minTemp) {
                    message += `üå°Ô∏è Temperature too LOW: ${device.temperature.toFixed(1)}¬∞C (Min: ${device.minTemp}¬∞C)\n`;
                }
            }
            
            if (device.alarmType === 'humidity' || device.alarmType === 'both') {
                if (device.humidity > device.maxHumidity) {
                    message += `üíß Humidity too HIGH: ${Math.round(device.humidity)}% (Max: ${device.maxHumidity}%)\n`;
                } else if (device.humidity < device.minHumidity) {
                    message += `üíß Humidity too LOW: ${Math.round(device.humidity)}% (Min: ${device.minHumidity}%)\n`;
                }
            }
            
            console.log(message);
        }

        // Play alarm sound
        function playAlarmSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 1000;
            oscillator.type = 'square';
            gainNode.gain.value = 0.3;

            oscillator.start();
            setTimeout(() => oscillator.stop(), 500);
        }

        // Device detail modal
        function openDeviceDetail(deviceId) {
            currentDeviceId = deviceId;
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            document.getElementById('detailDeviceName').textContent = device.name;
            document.getElementById('maxTemp').value = device.maxTemp || 27;
            document.getElementById('minTemp').value = device.minTemp || 18;
            document.getElementById('maxHumidity').value = device.maxHumidity || 70;
            document.getElementById('minHumidity').value = device.minHumidity || 30;
            document.getElementById('alarmEnabled').checked = device.alarmEnabled;

            // Show/hide connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (!device.connected) {
                connectionStatus.style.display = 'block';
            } else {
                connectionStatus.style.display = 'none';
            }

            updateDetailModal(device);

            document.getElementById('deviceDetailModal').style.display = 'block';
        }

        function updateDetailModal(device) {
            document.getElementById('detailTemp').textContent = device.temperature?.toFixed(1) + '¬∞C' || '--¬∞C';
            document.getElementById('detailHumidity').textContent = device.humidity ? Math.round(device.humidity) + '%' : '--%';
            document.getElementById('detailBattery').textContent = 'üîã ' + (device.battery ? Math.round(device.battery) + '%' : '--%');
        }

        function closeDetailModal() {
            document.getElementById('deviceDetailModal').style.display = 'none';
            currentDeviceId = null;
        }

        function updateAlarmSettings() {
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) return;

            device.maxTemp = parseFloat(document.getElementById('maxTemp').value);
            device.minTemp = parseFloat(document.getElementById('minTemp').value);
            device.maxHumidity = parseFloat(document.getElementById('maxHumidity').value);
            device.minHumidity = parseFloat(document.getElementById('minHumidity').value);
            device.alarmEnabled = document.getElementById('alarmEnabled').checked;

            saveDevices();
            
            // Re-check alarm with new settings
            checkAlarm(device);
            renderDevices();
            
            alert('‚úÖ Alarm settings saved!\n\nüå°Ô∏è Temperature: ' + device.minTemp + '¬∞C - ' + device.maxTemp + '¬∞C\nüíß Humidity: ' + device.minHumidity + '% - ' + device.maxHumidity + '%');
        }

        function startDeviceLogging() {
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) return;

            device.logging = true;
            device.loggingInterval = setInterval(() => {
                const logEntry = {
                    timestamp: new Date(),
                    temperature: device.temperature,
                    humidity: device.humidity,
                    battery: device.battery,
                    alarm: device.alarmActive
                };
                device.logs.push(logEntry);
                
                const container = document.getElementById('detailLogContainer');
                const entry = document.createElement('div');
                entry.className = 'log-entry' + (logEntry.alarm ? ' alarm' : '');
                entry.textContent = `[${logEntry.timestamp.toLocaleTimeString()}] üå°Ô∏è${logEntry.temperature.toFixed(1)}¬∞C üíß${Math.round(logEntry.humidity)}% üîã${Math.round(logEntry.battery)}%`;
                container.appendChild(entry);
                container.scrollTop = container.scrollHeight;
            }, 5000);
        }

        function stopDeviceLogging() {
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) return;

            device.logging = false;
            clearInterval(device.loggingInterval);
        }

        function exportDeviceData() {
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device || device.logs.length === 0) {
                alert('No data to export');
                return;
            }

            const csv = "Timestamp,Temperature,Humidity,Battery,Alarm\n" + 
                device.logs.map(log => 
                    `${log.timestamp.toISOString()},${log.temperature},${log.humidity},${log.battery},${log.alarm}`
                ).join("\n");

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${device.name}_data.csv`;
            a.click();
        }

        function removeDevice() {
            if (!confirm('Are you sure you want to remove this device?')) return;

            devices = devices.filter(d => d.id !== currentDeviceId);
            saveDevices();
            renderDevices();
            closeDetailModal();
        }

        // Reconnect to a saved device
        async function reconnectDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            try {
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth not supported. Use Chrome or Edge.');
                }

                // Request device again
                const bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'LYWSD' },
                        { namePrefix: 'MHO-C401' },
                        { namePrefix: 'Xiaomi' },
                        { namePrefix: 'ATC' }
                    ],
                    optionalServices: [
                        XIAOMI_SERVICE,
                        '0000180f-0000-1000-8000-00805f9b34fb',
                        '0000180a-0000-1000-8000-00805f9b34fb'
                    ]
                });

                await connectDevice(deviceId, bleDevice);
                renderDevices();

            } catch (error) {
                console.error('Reconnection error:', error);
                if (error.name !== 'NotFoundError') {
                    alert('Failed to reconnect: ' + error.message);
                }
            }
        }

        // Reconnect all disconnected devices
        async function reconnectAllDevices() {
            const disconnectedDevices = devices.filter(d => !d.connected);
            
            if (disconnectedDevices.length === 0) {
                alert('All devices are already connected!');
                return;
            }

            const btn = document.getElementById('reconnectAllBtn');
            btn.disabled = true;
            btn.textContent = 'Connecting...';

            for (const device of disconnectedDevices) {
                try {
                    await reconnectDevice(device.id);
                    // Small delay between connections
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('Failed to reconnect', device.name, error);
                    // Continue with next device
                }
            }

            btn.disabled = false;
            btn.textContent = 'üîÑ Reconnect All';
            renderDevices();
        }

        // Connect from detail modal
        async function connectFromDetail() {
            if (!currentDeviceId) return;
            
            const device = devices.find(d => d.id === currentDeviceId);
            if (!device) return;

            try {
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.innerHTML = '<div style="text-align: center;"><div style="font-size: 48px;">üîÑ</div><p>Connecting to ' + device.name + '...</p></div>';

                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth not supported. Use Chrome or Edge.');
                }

                // Request device
                const bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'LYWSD' },
                        { namePrefix: 'MHO-C401' },
                        { namePrefix: 'Xiaomi' },
                        { namePrefix: 'ATC' }
                    ],
                    optionalServices: [
                        XIAOMI_SERVICE,
                        '0000180f-0000-1000-8000-00805f9b34fb',
                        '0000180a-0000-1000-8000-00805f9b34fb'
                    ]
                });

                // Connect
                await connectDevice(currentDeviceId, bleDevice);
                
                // Hide connection status
                connectionStatus.style.display = 'none';
                
                // Update display
                renderDevices();
                updateDetailModal(device);

            } catch (error) {
                console.error('Connection error:', error);
                const connectionStatus = document.getElementById('connectionStatus');
                connectionStatus.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">‚ùå Connection Failed</div>
                    <p style="color: #666; margin-bottom: 15px;">${error.message}</p>
                    <button class="button success" onclick="connectFromDetail()" style="max-width: 300px; margin: 0 auto;">
                        üîÑ Try Again
                    </button>
                `;
            }
        }

        // Initialize
        loadDevices();
    </script>
</body>
</html>